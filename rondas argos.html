<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#033658">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="ronda.css" rel="stylesheet">
    <title>App - Auditoria de Postos</title>
    <style>
      .logo {
        position: absolute;
        top: 70px;
        left: 10px;
        max-width: 120px;
        height: auto;
        z-index: 20;
      }
            
    </style>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  </head>
  <body>
    <!-- menus laterais removidos: left 'Navegar' e right 'Menu' -->
    <div class="topbar">
      <div class="brand">
        <div class="logo"></div>
        <div class="title">Argos ‚Äî Auditorias de Postos</div>
      </div>
      <div class="top-actions">
        <button class="btn-primary" onclick="window.location.href='dashboard.html'">üìä Dashboard</button>
        <button class="btn-primary" onclick="window.location.href='registros.html'">üìã Registros</button>
        <button class="btn-ghost" onclick="exportAllPdf()">‚¨áÔ∏è Exportar</button>
      </div>
    </div>

    <div class="layout layout--centered">
      <div class="card">
        <header>
          <div>
            <h1>üõ°Ô∏è Formul√°rio de Auditoria de Postos</h1>
            <div class="small" style="margin-top:4px">App offline ‚Äî dados salvos localmente</div>
          </div>
        </header>

        <form id="rondaForm">
          <!-- SE√á√ÉO: DADOS DA AUDITORIA -->
          <div id="sec-dados" class="section-header">üìã Dados da Auditoria</div>
          
          <div class="row">
            <div>
              <label for="data">Data da Auditoria *</label>
              <input id="data" type="date" name="data" required />
            </div>
            <div>
              <label for="horaInicio">Hora In√≠cio</label>
              <input id="horaInicio" type="time" name="horaInicio" />
            </div>
            <div>
              <label for="horaFim">Hora T√©rmino</label>
              <input id="horaFim" type="time" name="horaFim" />
            </div>
            <div>
              <label for="turno">Turno</label>
              <select id="turno" name="turno">
                <option>Dia</option>
                <option>Noite</option>
              </select>
            </div>
          </div>

          <div class="row">
            <div>
              <label for="auditor">Auditor / Respons√°vel *</label>
              <input id="auditor" type="text" name="auditor" placeholder="Nome do auditor" required />
            </div>
            <div>
              <label for="matricula">Matr√≠cula</label>
              <input id="matricula" type="text" name="matricula" placeholder="Matr√≠cula do auditor" />
            </div>
          </div>

          <!-- SE√á√ÉO: DADOS DO POSTO -->
          <div id="sec-identificacao" class="section-header">üè¢ Identifica√ß√£o do Posto</div>
          
          <div class="row">
            <div>
              <label for="nomePosto">Nome do Posto / Unidade *</label>
              <input id="nomePosto" type="text" name="nomePosto" placeholder="Ex: Posto Central" required />
            </div>
            <div>
              <label for="codigoPosto">C√≥digo do Posto</label>
              <input id="codigoPosto" type="text" name="codigoPosto" placeholder="Ex: PST-001" />
            </div>
          </div>

          <div class="row">
            <div>
              <label for="endereco">Endere√ßo Completo</label>
              <input id="endereco" type="text" name="endereco" placeholder="Rua, n√∫mero, complemento" />
            </div>
          </div>

          <div class="row">
            <div>
              <label for="bairro">Bairro</label>
              <input id="bairro" type="text" name="bairro" placeholder="Bairro" />
            </div>
            <div>
              <label for="cidade">Cidade</label>
              <input id="cidade" type="text" name="cidade" placeholder="Cidade" />
            </div>
            <div>
              <label for="estado">Estado</label>
              <select id="estado" name="estado">
                <option value="">Selecione...</option>
                <option value="AC">AC</option>
                <option value="AL">AL</option>
                <option value="AP">AP</option>
                <option value="AM">AM</option>
                <option value="BA">BA</option>
                <option value="CE">CE</option>
                <option value="DF">DF</option>
                <option value="ES">ES</option>
                <option value="GO">GO</option>
                <option value="MA">MA</option>
                <option value="MT">MT</option>
                <option value="MS">MS</option>
                <option value="MG">MG</option>
                <option value="PA">PA</option>
                <option value="PB">PB</option>
                <option value="PR">PR</option>
                <option value="PE">PE</option>
                <option value="PI">PI</option>
                <option value="RJ">RJ</option>
                <option value="RN">RN</option>
                <option value="RS">RS</option>
                <option value="RO">RO</option>
                <option value="RR">RR</option>
                <option value="SC">SC</option>
                <option value="SP">SP</option>
                <option value="SE">SE</option>
                <option value="TO">TO</option>
              </select>
            </div>
          </div>

          <!-- SE√á√ÉO: RESPONS√ÅVEIS DO POSTO -->
          <div id="sec-responsaveis" class="section-header">üë• Respons√°veis do Posto</div>
          
          <div class="row">
            <div>
              <label for="responsavelPosto">Respons√°vel pelo Posto</label>
              <input id="responsavelPosto" type="text" name="responsavelPosto" placeholder="Nome do respons√°vel" />
            </div>
            <div>
              <label for="contatoResponsavel">Telefone / Contato</label>
              <input id="contatoResponsavel" type="text" name="contatoResponsavel" placeholder="(00) 00000-0000" />
            </div>
          </div>

          <div class="row">
            <div>
              <label for="supervisorArea">Supervisor da √Årea</label>
              <input id="supervisorArea" type="text" name="supervisorArea" placeholder="Nome do supervisor" />
            </div>
            <div>
              <label for="quantidadeFuncionarios">Quantidade de Funcion√°rios</label>
              <input id="quantidadeFuncionarios" type="number" name="quantidadeFuncionarios" placeholder="0" min="0" />
            </div>
          </div>

          <!-- SE√á√ÉO: CHECKLIST DE AUDITORIA -->
          <div id="sec-checklist" class="section-header">‚úÖ Checklist de Inspe√ß√£o</div>
          <div>
            <label>Itens de Inspe√ß√£o</label>
            <div style="display:flex;gap:8px;align-items:center;margin:6px 0">
              <div class="small" style="min-width:120px">Estilo de numera√ß√£o:</div>
              <select id="checklistStyle" style="padding:6px;border-radius:6px;border:1px solid #e6edf3">
                <option value="none">Nenhum</option>
                <option value="numbers">N√∫meros</option>
                <option value="letters">Letras</option>
              </select>
              <div class="small" style="min-width:140px;margin-left:8px">Tipo de resposta:</div>
              <select id="responseMode" disabled style="padding:6px;border-radius:6px;border:1px solid #e6edf3" title="Tipo de resposta fixo para Texto livre">
                <option value="text" selected>Texto livre (letras e n√∫meros)</option>
              </select>
            </div>
            <div id="checklist" class="checklist">
              <!-- entradas din√¢micas -->
            </div>
            <div style="display:flex;gap:8px;margin-top:8px">
              <input id="newItem" type="text" placeholder="Adicionar item da checklist" />
              <button type="button" id="addItem">Adicionar</button>
            </div>
          </div>

          <div style="margin-top:12px">
            <label for="obs">Observa√ß√µes</label>
            <textarea id="obs" placeholder="Observa√ß√µes gerais"></textarea>
          </div>

          <div style="margin-top:8px">
            <label for="photos">Fotos (opcional)</label>
            <input id="photos" type="file" accept="image/*" multiple />
            <div id="photosPreview" class="photo-preview"></div>
          </div>

          <div style="margin-top:12px" class="actions">
            <button type="submit">Salvar registro</button>
            <button type="button" id="exportCsv" class="secondary">Exportar CSV</button>
            <button type="button" id="print" class="secondary">Imprimir</button>
            <button type="button" id="clearForm" class="danger">Limpar</button>
          </div>
        </form>
      </div>

      <!-- aside de Registros Salvos removido conforme solicitado -->
    </div>

    <!-- Adicionando a logo -->
    <img src="fotos/Logo-Argosvig-2-e1745505100362.webp" alt="Logo" class="logo">

    <script>
      // Helpers
      const $ = id => document.getElementById(id);
      const storageKey = 'rondas_registros_v1';
      const storageSummaryKey = 'rondas_summary_v1';

      // Checklist padr√£o de auditoria de postos (substitu√≠do pelos 9 itens solicitados)
      const defaultChecklist = [
        { category: 'Efetivo do Posto (Avaliar pelo Programa de Gest√£o de Compet√™ncias e Requisitos do Cliente)', item: 'Efetivo do Posto' },
        { category: 'Postura e Apresenta√ß√£o (Avaliar o Atendimento, Iniciativa, Comportamento e Condi√ß√µes de Uniforme)', item: 'Postura e Apresenta√ß√£o' },
        { category: 'Instru√ß√µes Espec√≠ficas (Avaliar o conhecimento, cumprimento dos procedimentos e necessidade de revis√£o)', item: 'Instru√ß√µes Espec√≠ficas' },
        { category: 'Livro de Ocorr√™ncias (Avaliar o preenchimento correto, assinaturas e acumulo de livros de mes√™s anteriores)', item: 'Livro de Ocorr√™ncias' },
        { category: 'Equipamentos do Posto (Avaliar as condi√ß√µes e quantidades de material carga do posto)', item: 'Equipamentos do Posto' },
        { category: 'Armamento e Colete Bal√≠stico (Avaliar as condi√ß√µes, quantidades, licen√ßas e validades das armas e coletes)', item: 'Armamento e Colete Bal√≠stico' },
        { category: 'Carteira Nacional de Vigilante - CNV (Avaliar o porte e validade das CNVs dos Vigilantes)', item: 'Carteira Nacional de Vigilante - CNV' },
        { category: 'Condi√ß√µes do Posto (Avaliar a necessidade de manuten√ß√£o predial e defeitos na seguran√ßa eletr√¥nica etc)', item: 'Condi√ß√µes do Posto' },
        { category: 'Treinamento (Avaliar a efic√°cia do √∫ltimo treinamento obrigat√≥rio executado no posto)', item: 'Treinamento' }
      ];

      function readStorage(){
        try{return JSON.parse(localStorage.getItem(storageKey) || '[]')}catch(e){return []}
      }
      function writeStorage(arr){localStorage.setItem(storageKey, JSON.stringify(arr))}

      // summary (gr√°fico) removido ‚Äî fun√ß√µes relacionadas exclu√≠das

      // Inicializa√ß√£o do formul√°rio
      function init(){
        // data padr√£o = hoje
        const today = new Date().toISOString().slice(0,10);
        $('data').value = today;

        // popular checklist
        const checklistEl = $('checklist');
        defaultChecklist.forEach(item => addChecklistRow(item.item, item.category));

          // carregar registros salvos
          renderSavedList();
      }

      function createStatusControl(value){
        const mode = $('responseMode') ? $('responseMode').value : 'binary';
        if(mode === 'numbers'){
          const sel = document.createElement('select'); sel.className='item-status';
          for(let i=1;i<=5;i++){ const o = document.createElement('option'); o.value = String(i); o.textContent = String(i); sel.appendChild(o); }
          if(value) sel.value = value;
          return sel;
        }
        if(mode === 'letters'){
          const sel = document.createElement('select'); sel.className='item-status';
          const letters = ['A','B','C','D','E'];
          letters.forEach(l=>{ const o = document.createElement('option'); o.value=l; o.textContent=l; sel.appendChild(o); });
          if(value) sel.value = value;
          return sel;
        }
        if(mode === 'text'){
          const inp = document.createElement('input'); inp.type='text'; inp.className='item-status'; inp.placeholder='Resposta'; inp.style.minWidth='80px';
          if(value) inp.value = value;
          return inp;
        }
        // default binary
        const sel = document.createElement('select'); sel.className='item-status';
        ['OK','N√£o OK','N/A'].forEach(t=>{ const o=document.createElement('option'); o.value=t; o.textContent=t; sel.appendChild(o); });
        if(value) sel.value = value;
        return sel;
      }

      function addChecklistRow(text='', checklistName='', statusValue){ 
        const id = 'chk_' + Math.random().toString(36).slice(2,8);
        const div = document.createElement('div');
        div.className = 'checkrow';
        const nameInput = document.createElement('input');
        nameInput.type='text'; nameInput.className='item-checklist-name'; nameInput.value = checklistName || ''; nameInput.placeholder='Nome da checklist';
        nameInput.style = 'width:140px;padding:8px;border-radius:6px;border:1px solid #e6edf3;margin-right:6px';
        const textInput = document.createElement('input');
        textInput.type='text'; textInput.className='item-text'; textInput.value = text || ''; textInput.placeholder='Descri√ß√£o do item';
        textInput.style = 'flex:1;padding:8px;border-radius:6px;border:1px solid #e6edf3';
        const statusControl = createStatusControl(statusValue);
        const btn = document.createElement('button'); btn.type='button'; btn.className='remove-item'; btn.title='Remover'; btn.textContent='‚úï';
        btn.addEventListener('click', ()=>div.remove());
        div.appendChild(nameInput); div.appendChild(textInput); div.appendChild(statusControl); div.appendChild(btn);
        $('checklist').appendChild(div);
      }

      function updateAllStatusControls(){
        const rows = Array.from(document.querySelectorAll('#checklist .checkrow'));
        rows.forEach((r)=>{
          const statusOld = r.querySelector('.item-status');
          const value = statusOld ? statusOld.value : '';
          const newControl = createStatusControl(value);
          if(statusOld) statusOld.replaceWith(newControl);
        });
      }

      function escapeHtml(str){return String(str).replace(/[&<>\\\"]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));}

      // Fotos preview
      $('photos').addEventListener('change', function(){
        const preview = $('photosPreview'); preview.innerHTML='';
        Array.from(this.files).forEach(file=>{
          const reader = new FileReader();
          reader.onload = e=>{
            const img = document.createElement('img'); img.src = e.target.result; preview.appendChild(img);
          };
          reader.readAsDataURL(file);
        });
      });

      // endpoint do servidor (ajuste se necess√°rio)
      const serverEndpoint = 'http://localhost:3000/api/rondas';

      async function sendToServer(registro){
        if(!serverEndpoint) return Promise.resolve();
        try{
          const resp = await fetch(serverEndpoint, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(registro),
            keepalive: true
          });
          if(!resp.ok) throw new Error('server error');
          const data = await resp.json();
          console.log('Enviado para servidor, id:', data.id);
          return data;
        }catch(err){
          console.warn('N√£o foi poss√≠vel enviar ao servidor:', err.message);
          return Promise.reject(err);
        }
      }

      // adicionar item
      $('addItem').addEventListener('click', ()=>{
        const val = $('newItem').value.trim();
        if(!val) return alert('Digite o texto do item');
        addChecklistRow(val);
        $('newItem').value='';
      });

      // quando o modo de resposta mudar, atualizar controles existentes
      $('responseMode').addEventListener('change', ()=>{
        updateAllStatusControls();
      });

      // salvar registro
      $('rondaForm').addEventListener('submit', async (ev)=>{
        ev.preventDefault();
        const data = $('data').value;
        const horaInicio = $('horaInicio').value;
        const horaFim = $('horaFim').value;
        const turno = $('turno').value;
        const auditor = $('auditor').value.trim();
        const matricula = $('matricula').value.trim();
        const nomePosto = $('nomePosto').value.trim();
        const codigoPosto = $('codigoPosto').value.trim();
        const endereco = $('endereco').value.trim();
        const bairro = $('bairro').value.trim();
        const cidade = $('cidade').value.trim();
        const estado = $('estado').value;
        const responsavelPosto = $('responsavelPosto').value.trim();
        const contatoResponsavel = $('contatoResponsavel').value.trim();
        const supervisorArea = $('supervisorArea').value.trim();
        const quantidadeFuncionarios = $('quantidadeFuncionarios').value;
        const obs = $('obs').value.trim();

        const checklist = Array.from(document.querySelectorAll('#checklist .checkrow')).map((r,i)=>({
          checklistName: r.querySelector('.item-checklist-name') ? r.querySelector('.item-checklist-name').value.trim() : '',
          text: r.querySelector('.item-text').value.trim(),
          status: r.querySelector('.item-status') ? r.querySelector('.item-status').value : ''
        }));

        // fotos: converter para dataURL (aten√ß√£o em imagens grandes)
        const files = Array.from($('photos').files);
        const photos = await Promise.all(files.map(f=>fileToDataURL(f)));

        const registro = {
          id: Date.now(),
          data,
          horaInicio,
          horaFim,
          turno,
          auditor,
          matricula,
          posto: {
            nome: nomePosto,
            codigo: codigoPosto,
            endereco,
            bairro,
            cidade,
            estado,
            responsavel: responsavelPosto,
            contato: contatoResponsavel,
            supervisor: supervisorArea,
            quantidadeFuncionarios
          },
          obs,
          checklist,
          photos,
          checklistStyle: $('checklistStyle') ? $('checklistStyle').value : 'none'
        };

        const arr = readStorage(); arr.unshift(registro); writeStorage(arr);
        // atualizar summary incremental para evitar reprocessar dados pesados
        incrementSummaryForTurno(registro.turno, 1);
        // tentar enviar ao servidor (n√£o bloqueia a interface)
        sendToServer(registro).catch(()=>{});
        renderSavedList();
        alert('Registro salvo localmente');
        $('rondaForm').reset();
        init();
      });

      function fileToDataURL(file){
        return new Promise(resolve=>{
          const reader = new FileReader(); reader.onload = e=>resolve(e.target.result);
          reader.readAsDataURL(file);
        });
      }

      // Render lista de salvos
      function renderSavedList(listParam){
        const list = listParam || readStorage();
        const el = $('savedList'); el.innerHTML='';
        if(list.length===0){ el.innerHTML = '<div class="small">Nenhum registro salvo</div>'; return }
        list.forEach(item=>{
          const div = document.createElement('div'); div.className='item';
          const left = document.createElement('div');
                // Mostrar apenas o texto dos itens (sem o "Nome da checklist") na pr√©via
                const checklistItems = (item.checklist||[]).map(c=>c.text).filter(Boolean);
                let previewTitles = '';
                if(checklistItems.length>0){
                  const previewArr = checklistItems.slice(0,3);
                  previewTitles = previewArr.join(' ‚Ä¢ ');
                  if(checklistItems.length>3) previewTitles += ` (+${checklistItems.length-3})`;
                }
                const postoNome = item.posto?.nome || item.local || 'Sem identifica√ß√£o';
                left.innerHTML = `<div><strong>${item.data} ‚Äî ${item.turno}</strong></div><div class="small">${item.auditor || ''} ‚Ä¢ ${escapeHtml(postoNome)}</div>` + (previewTitles? `<div class="small">${escapeHtml(previewTitles)}</div>` : '');
          const right = document.createElement('div');
          right.style.display='flex'; right.style.gap='6px';
          const btnView = document.createElement('button'); btnView.textContent='Ver'; btnView.className='secondary';
          btnView.addEventListener('click', ()=>viewRegistro(item.id));
          const btnDel = document.createElement('button'); btnDel.textContent='Excluir'; btnDel.className='danger';
          btnDel.addEventListener('click', ()=>{ if(confirm('Excluir este registro?')) deleteRegistro(item.id); });
          const btnExport = document.createElement('button'); btnExport.textContent='Exportar PDF';
          btnExport.addEventListener('click', ()=>{ exportRegistroPdf(item); if(window.showToast) showToast('Exportado registro (PDF)', 'success'); else alert('Exportado registro (PDF)'); });
          right.appendChild(btnView); right.appendChild(btnExport); right.appendChild(btnDel);
          div.appendChild(left); div.appendChild(right);
          el.appendChild(div);
        });
      }

      // Fun√ß√µes do gr√°fico removidas porque a exibi√ß√£o foi retirada desta p√°gina

      function getPrefix(style, idx){
        if(!style || style==='none') return '';
        if(style==='numbers') return `${idx+1}.`;
        if(style==='letters'){
          // 0 -> A, 25 -> Z, 26 -> AA (simple conversion)
          let n = idx;
          let s = '';
          while(n >= 0){
            s = String.fromCharCode(65 + (n % 26)) + s;
            n = Math.floor(n/26) - 1;
          }
          return `${s}.`;
        }
        return '';
      }

            function viewRegistro(id){
                const arr = readStorage(); const item = arr.find(i=>i.id===id); if(!item) return alert('Registro n√£o encontrado');
                const win = window.open('','_blank','width=820,height=1100');
                const style = `
                  body{font-family: Arial, Helvetica, sans-serif; color:#0b1723; padding:20px}
                  .form-wrap{max-width:760px;margin:0 auto;background:#fff;border:1px solid #dfe7ee;padding:18px;border-radius:6px}
                  header{text-align:center;margin-bottom:12px}
                  header h1{margin:0;font-size:18px}
                  .meta{margin-top:6px;font-size:13px;color:#374151}
                  .info-table{width:100%;border-collapse:collapse;margin-top:12px}
                  .info-table td{padding:6px;border:1px solid #eef3f8;font-size:13px}
                  .section-title{margin-top:14px;margin-bottom:6px;font-weight:700}
                  .checklist-table{width:100%;border-collapse:collapse}
                  .checklist-table th,.checklist-table td{border:1px solid #eef3f8;padding:8px;text-align:left;font-size:13px}
                  .obs-box{min-height:80px;border:1px solid #eef3f8;padding:8px;border-radius:4px;background:#fbfdff}
                  .photos{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
                  .photos img{max-width:220px;max-height:160px;border:1px solid #e6eef8}
                  .actions{display:flex;justify-content:flex-end;margin-top:12px}
                  .btn{background:#0b63d1;color:#fff;padding:8px 12px;border-radius:6px;border:none;cursor:pointer}
                  @media print{ .actions{display:none} body{padding:0} .form-wrap{border:none;border-radius:0;padding:0} }
                `;

                const checklistHtml = (item.checklist||[]).map((c, idx)=>{
                  const prefix = getPrefix(item.checklistStyle || 'none', idx);
                  const namePart = c.checklistName ? `<div style="font-style:italic;color:#374151">${escapeHtml(c.checklistName)}</div>` : '';
                  const resp = c.status ? escapeHtml(String(c.status)) : '';
                  return `<tr><td style="width:60px">${escapeHtml(prefix)}</td><td style="width:220px">${namePart}${escapeHtml(c.text)}</td><td style="width:120px">${resp}</td></tr>`;
                }).join('');

                const photosHtml = (item.photos||[]).map(p=>`<img src="${p}"/>`).join('');

                const postoInfo = item.posto || {};
                const enderecoCompleto = [postoInfo.endereco, postoInfo.bairro, postoInfo.cidade, postoInfo.estado].filter(Boolean).join(', ');
                const html = `<!doctype html><html><head><meta charset="utf-8"><title>Auditoria ${item.data}</title><style>${style}</style></head><body>`+
                  `<div class="form-wrap">`+
                    `<header><h1>Relat√≥rio de Auditoria de Posto</h1><div class="meta">${item.data} ‚Äî ${item.turno} ${item.horaInicio?'('+ item.horaInicio + (item.horaFim?' - '+item.horaFim:'') +')':''}</div></header>`+
                    `<div class="section-title">Dados da Auditoria</div>`+
                    `<table class="info-table"><tr><td><strong>Auditor</strong><div>${escapeHtml(item.auditor||'')}</div></td><td><strong>Matr√≠cula</strong><div>${escapeHtml(item.matricula||'N/A')}</div></td></tr></table>`+
                    `<div class="section-title">Dados do Posto</div>`+
                    `<table class="info-table">`+
                    `<tr><td><strong>Nome do Posto</strong><div>${escapeHtml(postoInfo.nome||item.local||'')}</div></td><td><strong>C√≥digo</strong><div>${escapeHtml(postoInfo.codigo||'N/A')}</div></td></tr>`+
                    `<tr><td colspan="2"><strong>Endere√ßo</strong><div>${escapeHtml(enderecoCompleto||'N/A')}</div></td></tr>`+
                    `<tr><td><strong>Respons√°vel do Posto</strong><div>${escapeHtml(postoInfo.responsavel||'N/A')}</div></td><td><strong>Contato</strong><div>${escapeHtml(postoInfo.contato||'N/A')}</div></td></tr>`+
                    `<tr><td><strong>Supervisor</strong><div>${escapeHtml(postoInfo.supervisor||'N/A')}</div></td><td><strong>Qtd. Funcion√°rios</strong><div>${escapeHtml(postoInfo.quantidadeFuncionarios||'N/A')}</div></td></tr>`+
                    `</table>`+
                    `<div class="section-title">Checklist</div>`+
                    `<table class="checklist-table"><thead><tr><th style="width:60px">#</th><th>Item</th><th>Resposta</th></tr></thead><tbody>${checklistHtml}</tbody></table>`+
                    `<div class="section-title">Observa√ß√µes</div><div class="obs-box">${escapeHtml(item.obs||'')}</div>`+
                    `<div class="section-title">Fotos</div><div class="photos">${photosHtml}</div>`+
                    `<div class="actions"><button class="btn" id="printBtn">Salvar / Imprimir PDF</button></div>`+
                  `</div>`+
                  `<script>window.addEventListener('load', function(){ const b = document.getElementById('printBtn'); if(b) b.addEventListener('click', function(){ window.print(); }); });<\/script>`+
                  `</body></html>`;

                win.document.write(html); win.document.close();
            }

      function deleteRegistro(id){
        let arr = readStorage();
        const found = arr.find(i=>i.id===id);
        arr = arr.filter(i=>i.id!==id);
        writeStorage(arr);
        if(found) incrementSummaryForTurno(found.turno, -1);
        renderSavedList();
      }

      // Exports
      // Nota: download JSON antigo removido como fallback ‚Äî exportar agora √© em PDF via jsPDF

      

      function exportAllCsv(){
        const arr = readStorage();
        if(arr.length===0) return alert('Nada para exportar');
        const rows = [];
        // Cabe√ßalho
        rows.push(['id','data','turno','auditor','local','obs','checklist']);
        arr.forEach(r=>{
          const chk = r.checklist.map(c=>`${c.text}:${c.status}`).join('|');
          rows.push([r.id,r.data,r.turno,r.auditor,r.local, (r.obs||'').replace(/\n/g,' '), chk]);
        });
        const csv = rows.map(r=>r.map(cell=>`"${String(cell).replace(/"/g,'""')}"`).join(',')).join('\n');
        const dataStr = 'data:text/csv;charset=utf-8,' + encodeURIComponent(csv);
        const a = document.createElement('a'); a.setAttribute('href', dataStr); a.setAttribute('download', 'rondas.csv'); document.body.appendChild(a); a.click(); a.remove();
      }

      // buttons
      $('exportCsv').addEventListener('click', ()=>exportAllCsv());
      $('print').addEventListener('click', ()=>window.print());
      $('clearForm').addEventListener('click', ()=>{ if(confirm('Limpar formul√°rio?')){$('rondaForm').reset(); init(); $('photosPreview').innerHTML='';} });
      $('clearAll').addEventListener('click', ()=>{ if(confirm('Excluir todos os registros?')){ localStorage.removeItem(storageKey); localStorage.removeItem(storageSummaryKey); renderSavedList(); const empty = { labels:['Dia','Noite'], counts:[0,0] }; writeSummary(empty); updateChartFromSummary(empty); } });

      // Renderizar registros na mesma p√°gina
      document.addEventListener('DOMContentLoaded', () => {
        const list = readStorage();
        renderSavedList(list);

        const searchInput = document.getElementById('savedSearch');
        searchInput.addEventListener('input', (e) => {
          const query = e.target.value.toLowerCase();
          const filtered = list.filter(item => {
            return (
              item.auditor?.toLowerCase().includes(query) ||
              item.posto?.nome?.toLowerCase().includes(query) ||
              item.data?.includes(query)
            );
          });
          renderSavedList(filtered);
        });

        // exportPdf handler moved to `postos.js` (exportAllPdf)
      });

      // inicializa
      init();
    </script>
    <script src="postos.js"></script>
  </body>
</html>